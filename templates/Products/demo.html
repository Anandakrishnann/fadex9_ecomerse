<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.css" rel="stylesheet"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }

        .container {
            margin-top: 20px;
        }

        #imagePreview {
            display: flex;
            flex-wrap: wrap;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        #imagePreview .image-container {
            position: relative;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        #imagePreview .image-container img {
            max-width: 280px;
            max-height: 280px;
            margin-right: 10px;
            object-fit: cover;
            border-radius: 4px;
        }

        #imagePreview .image-container .btn {
            margin-left: 10px;
        }

        .modal-content {
            border-radius: 8px;
        }

        .modal-header {
            border-bottom: none;
        }

        .modal-footer {
            border-top: none;
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            color: #000;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <form method="post" enctype="multipart/form-data" id="variant-image-form"> 
        {% csrf_token %} 
        <div class="form-group"> 
            <label for="images">Select Images</label> 
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple required> 
            <small class="form-text text-muted">Please upload valid image files.</small> 
        </div> 
 
        <button type="submit" class="btn btn-primary">Upload Images</button> 
      
    </form> 
 
    <!-- Image Preview Section --> 
    <div class="container mt-4" style="width: 100%"> 
        <h4 style="padding-top: 5px">Image Preview</h4> 
        <div id="imagePreview" style="width: 100%; overflow: auto; border: 1px solid #ddd; padding: 10px;"></div> 
    </div> 
 
    <!-- Modal for Cropping Image --> 
    <button type="button" style="display: none" id="openCropperModalBtn" data-bs-toggle="modal" data-bs-target="#cropperModal"></button> 
 
    <div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered modal-lg"> 
            <div class="modal-content"> 
                <div class="modal-header"> 
                    <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5> 
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> 
                </div> 
                <div class="modal-body" style="width: 100%; height: 400px; overflow: hidden; display: flex; justify-content: center; align-items: center;"> 
                    <img id="imageToCrop" style="max-width: 100%; max-height: 100%" /> 
                </div> 
                <div class="modal-footer"> 
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> 
                    <button type="button" id="cropAndSave" class="btn btn-primary">Crop and Save</button> 
                </div> 
            </div> 
        </div> 
    </div> 
 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script> 
 
    <script> 
        document.addEventListener("DOMContentLoaded", () => { 
            const form = document.getElementById("variant-image-form"); 
            const imageInput = document.getElementById("images"); 
            const imagePreview = document.getElementById("imagePreview"); 
            const openCropperModalBtn = document.getElementById("openCropperModalBtn"); 
            const imageToCrop = document.getElementById("imageToCrop"); 
            const cropAndSave = document.getElementById("cropAndSave"); 
            const cropperModalElement = document.getElementById("cropperModal"); 
 
            let cropper; // hold the cropper js instance 
            let currentImage; 
            let originalImageBlobs = []; 
 
            const validateImage = (file) => { 
                const allowedExtensions = /\.(jpg|jpeg|png|gif)$/i; 
                if (!allowedExtensions.test(file.name)) { 
                    alert("Please upload a valid image file (jpg, jpeg, png, gif)"); 
                    return false; 
                } 
                return true; 
            }; 
 
            imageInput.addEventListener("change", (event) => { 
                const files = event.target.files; 
 
                Array.from(files).forEach((file) => { 
                    if (!validateImage(file)) { 
                        return; 
                    } 
                    const reader = new FileReader(); 
 
                    reader.onload = (event) => { 
                        const imageContainer = document.createElement("div"); 
                        imageContainer.className = "image-container"; 
 
                        const img = document.createElement("img"); 
                        img.src = event.target.result; 
                        img.className = "imagePreview"; 
 
                        const buttonContainer = document.createElement("div"); 
                        buttonContainer.style.display = "flex"; 
                        buttonContainer.style.flexDirection = "column"; 
 
                        const deleteButton = document.createElement("button"); 
                        deleteButton.className = "btn btn-danger btn-sm mb-2"; 
                        deleteButton.innerText = "Remove"; 
                        deleteButton.addEventListener("click", () => { 
                            imageContainer.remove(); // Removes the image container from the DOM 
                            originalImageBlobs = originalImageBlobs.filter( 
                                (item) => item.id !== img.src 
                            ); // filters out the removed image from the array 
                            updateFileInput(); // Updates the file input with the current images 
                        }); 
 
                        buttonContainer.appendChild(deleteButton); 
                        imageContainer.appendChild(img); 
                        imageContainer.appendChild(buttonContainer); 
                        imagePreview.appendChild(imageContainer); 
 
                        img.addEventListener("click", () => { 
                            imageToCrop.src = img.src; 
                            currentImage = img; 
                            openCropperModalBtn.click(); 
                        }); 
 
                        const originalFile = new File([file], file.name, { type: file.type }); 
                        originalImageBlobs.push({ 
                            id: event.target.result, 
                            blob: originalFile, 
                        }); 
                        updateFileInput(); 
                    }; 
 
                    reader.readAsDataURL(file); 
                }); 
            }); 
 
            cropperModalElement.addEventListener("shown.bs.modal", () => { 
                cropper = new Cropper(imageToCrop, { 
                    aspectRatio: 1, 
                    viewMode: 2, 
                    autoCropArea: 1, 
                }); 
            }); 
 
            cropperModalElement.addEventListener("hidden.bs.modal", () => { 
                if (cropper) { 
                    cropper.destroy(); 
                    cropper = null; 
                } 
            }); 
 
            cropAndSave.addEventListener("click", () => { 
                if (cropper) { 
                    const canvas = cropper.getCroppedCanvas(); 
 
                    canvas.toBlob((blob) => { 
                        const url = URL.createObjectURL(blob); 
 
                        currentImage.src = url; 
 
                        // Create a new File object from the blob 
                        const croppedFile = new File(
                            [blob],
                            `croppedImage_${Date.now()}.jpg`,
                            { type: "image/jpeg" }
                        );
 
                        // Replace the original blob with the cropped blob 
                        originalImageBlobs = originalImageBlobs.map((item) => { 
                            if (item.id === imageToCrop.src) { 
                                return { id: url, blob: croppedFile }; 
                            } 
                            return item; 
                        }); 
 
                        updateFileInput(); 
 
                        const modal = bootstrap.Modal.getInstance(cropperModalElement);
                        modal.hide(); 
                    }, 'image/jpeg'); 
                } 
            }); 
 
            function updateFileInput() { 
                const dataTransfer = new DataTransfer(); 
                originalImageBlobs.forEach((item) => { 
                    dataTransfer.items.add(item.blob); 
                }); 
                imageInput.files = dataTransfer.files; 
            } 
 
            form.addEventListener("submit", (event) => { 
                if (imageInput.files.length === 0) { 
                    alert("Image is required"); 
                    event.preventDefault(); 
                } 
            }); 
        }); 
    </script>
</body>
</html>
